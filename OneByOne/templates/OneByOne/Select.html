{% extends "global/Page.html" %}
{% load otree static %}

{% block styles %}
    <link href='{% static "devilsTask/css/coinGrid.css" %}' rel="stylesheet" />
{% endblock %}

{% block content %}

    <div class="container">
        <div class="row">
            <div class="col-9">
                <div class="outerGrid">
                    <div id="coinWrapper" class="selectionWrapper"></div>
                    <button id="btnCollect" class="collectPoints buttonBoth otree-next-button">Punkte sammeln</button>
                    <button id="btnNewRound" class="newRound buttonBoth otree-next-button">Neue Runde</button>
                </div>
            </div>

            <div class="col-3">
                <p>Runde: {{ round }}</p>
                <p>Gewonnene Punkte: {{ total_payoff }}</p>
                <div id="pointWrapper" class="pointGrid"></div>
            </div>
        </div>
    </div>

    <input type="hidden" name=round_collected_coins id="round_collected_coins" />
    <input type="hidden" name=round_clicks id="round_clicks" />
    <input type="hidden" name=round_time id="round_time" />
    {{ form.round_collected_coins.errors }}
    {{ form.round_clicks.errors }}
    {{ form.round_time.errors }}

{% endblock %}

{% block scripts %}
    <script src="{% static "devilsTask/js/select.js" %}"></script>
    <script>
        window.onload = resetField;

        let score = 0;
        let pointsToAdd;
        let randomDevil;
        const startTime = new Date();
        const btnCollect = document.getElementById("btnCollect");
        const btnNewRound = document.getElementById("btnNewRound");
        const coinGrid = document.getElementById("coinWrapper");
        const roundCollectedCoins = document.getElementById("round_collected_coins");
        const roundClicks = document.getElementById("round_clicks");
        const roundTime = document.getElementById("round_time");

        function resetField() {
            drawPoints();

            // random number between 0 and num_coins
            randomDevil = Math.floor(Math.random() * {{ Constants.num_coins }});
            pointsToAdd = 0;

            console.log("random Devil: " + randomDevil);
            let firstTime = (coinGrid.childNodes.length === 0);
            if (firstTime) {
                addCoins();
            } else {
                removeCoinEventListeners();
                addCoinListeners();
            }

            showElement(btnCollect);
            btnCollect.addEventListener("click", collectPoints);

            hideElement(btnNewRound);
            btnNewRound.addEventListener("click", startNewRoundAfterDevil);
        }

        function addCoins() {
            for (let i = 0; i < {{ Constants.num_coins }}; i++) {
                let img = document.createElement("img");
                img.classList.add('coin');
                coinGrid.appendChild(img);
                addCoinListeners();
            }
        }

        function addCoinListeners() {
            for (let i = 0; i < coinGrid.childNodes.length; i++) {
                let coin = coinGrid.childNodes[i];
                coin.style.backgroundColor = "#FFF";
                coin.src = '{% static 'devilsTask/img/questionMark.png' %}';
                if (i === randomDevil) {
                    coin.addEventListener("click", revealDevil);
                } else {
                    coin.addEventListener("click", revealCoin);
                }
            }
        }

        function revealCoin() {
            pointsToAdd += 1;
            console.log("points to add: " + pointsToAdd);
            this.src = '{% static 'devilsTask/img/coin.png' %}';
            this.style.backgroundColor = "#90EE90";
            this.removeEventListener("click", revealCoin);
        }

        function revealDevil() {
            pointsToAdd = 0;
            console.log("points to add: " + pointsToAdd);
            this.src = '{% static 'devilsTask/img/devil.jpg' %}';
            removeCoinEventListeners();
            showElement(btnNewRound);
            hideElement(btnCollect);
        }

        function collectPoints() {
            hideElement(document.getElementById("btnCollect"));
            removeCoinEventListeners();
            trackTime();
            score += pointsToAdd;
            roundCollectedCoins.value = score;
            trackClicks();
        }

        function startNewRoundAfterDevil() {
            trackTime();
            roundCollectedCoins.value = 0;
            trackClicks();
        }

        function drawPoints() {
            let pointGrid = document.getElementById("pointWrapper");
            for (let i = 0; i < {{ total_payoff }}; i++) {
                let point = document.createElement("div");
                point.classList.add("point");
                pointGrid.appendChild(point);
            }
        }

        function trackTime() {
            roundTime.value = new Date() - startTime;
        }

        function trackClicks() {
            roundClicks.value = score;
        }

    </script>
{% endblock %}
